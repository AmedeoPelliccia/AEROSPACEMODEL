name: Validate Lifecycle Registry

on:
  push:
    paths:
      - 'lifecycle/**'
  pull_request:
    paths:
      - 'lifecycle/**'

jobs:
  yamllint:
    name: YAML Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install yamllint
        run: |
          sudo apt-get update
          sudo apt-get install -y yamllint
      
      - name: Run yamllint on lifecycle files
        run: |
          cat > .yamllint << 'EOF'
          extends: default
          rules:
            line-length:
              max: 200
              level: warning
            truthy: disable
            indentation:
              spaces: 2
            comments:
              min-spaces-from-content: 1
          EOF
          
          yamllint -c .yamllint lifecycle/LC_PHASE_REGISTRY.yaml
          yamllint -c .yamllint lifecycle/TLI_GATE_RULEBOOK.yaml
          yamllint -c .yamllint lifecycle/T_SUBDOMAIN_LC_ACTIVATION.yaml

  validate-lc-phase-registry:
    name: Validate LC Phase Registry
    runs-on: ubuntu-latest
    needs: yamllint
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml jsonschema
      
      - name: Validate LC Phase Registry integrity
        run: |
          python << 'EOFPYTHON'
          import yaml
          from pathlib import Path
          
          # Load LC Phase Registry
          with open('lifecycle/LC_PHASE_REGISTRY.yaml') as f:
              registry = yaml.safe_load(f)
          
          print("Validating LC Phase Registry...")
          
          # Check canonical LC set LC01-LC14
          plm_phases = registry.get('plm_phases', {})
          ops_phases = registry.get('ops_phases', {})
          
          all_phases = set(plm_phases.keys()) | set(ops_phases.keys())
          expected_phases = {f'LC{i:02d}' for i in range(1, 15)}
          
          if all_phases != expected_phases:
              missing = expected_phases - all_phases
              extra = all_phases - expected_phases
              if missing:
                  print(f"❌ ERROR: Missing phases: {missing}")
              if extra:
                  print(f"❌ ERROR: Extra phases: {extra}")
              exit(1)
          
          print("✅ All 14 lifecycle phases present (LC01-LC14)")
          
          # Check baseline producer locks
          baseline_rules = registry.get('baseline_rules', {})
          
          fbl_producer = baseline_rules.get('FBL', {}).get('producer_lc')
          dbl_producer = baseline_rules.get('DBL', {}).get('producer_lc')
          pbl_producer = baseline_rules.get('PBL', {}).get('producer_lc')
          
          if fbl_producer != 'LC02':
              print(f"❌ ERROR: FBL producer must be LC02, got {fbl_producer}")
              exit(1)
          if dbl_producer != 'LC04':
              print(f"❌ ERROR: DBL producer must be LC04, got {dbl_producer}")
              exit(1)
          if pbl_producer != 'LC10':
              print(f"❌ ERROR: PBL producer must be LC10, got {pbl_producer}")
              exit(1)
          
          print("✅ Baseline producer locks validated:")
          print("   - FBL at LC02 ✓")
          print("   - DBL at LC04 ✓")
          print("   - PBL at LC10 ✓")
          
          # Check that LC09 cannot produce PBL
          lc09 = plm_phases.get('LC09', {})
          if lc09.get('baseline_producer'):
              print("❌ ERROR: LC09 cannot be a baseline producer")
              exit(1)
          
          print("✅ LC09 does not produce baselines (ESG is assessment only)")
          
          print("\n✅ LC Phase Registry validation PASSED")
          EOFPYTHON

  validate-t-subdomain-activation:
    name: Validate T-Subdomain Activation
    runs-on: ubuntu-latest
    needs: yamllint
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml jsonschema
      
      - name: Validate against JSON Schema
        run: |
          python << 'EOFPYTHON'
          import yaml
          import json
          import jsonschema
          from pathlib import Path
          
          print("Loading JSON Schema...")
          with open('lifecycle/schemas/t_subdomain_lc_activation.schema.json') as f:
              schema = json.load(f)
          
          print("Loading T_SUBDOMAIN_LC_ACTIVATION.yaml...")
          with open('lifecycle/T_SUBDOMAIN_LC_ACTIVATION.yaml') as f:
              data = yaml.safe_load(f)
          
          print("Validating against schema...")
          try:
              jsonschema.validate(instance=data, schema=schema)
              print("✅ Schema validation PASSED")
          except jsonschema.exceptions.ValidationError as e:
              print(f"❌ Schema validation FAILED: {e.message}")
              print(f"   Path: {list(e.path)}")
              exit(1)
          EOFPYTHON
      
      - name: Validate T-Subdomain Activation Rules
        run: |
          python << 'EOFPYTHON'
          import yaml
          
          with open('lifecycle/T_SUBDOMAIN_LC_ACTIVATION.yaml') as f:
              activation = yaml.safe_load(f)
          
          print("Validating T-Subdomain Activation Rules...")
          
          validation_rules = activation.get('validation_rules', [])
          expected_rules = ['VAL-001', 'VAL-002', 'VAL-003', 'VAL-004', 'VAL-005', 'VAL-006']
          
          rule_ids = [rule['id'] for rule in validation_rules]
          
          for expected in expected_rules:
              if expected not in rule_ids:
                  print(f"❌ ERROR: Missing validation rule {expected}")
                  exit(1)
          
          print(f"✅ All {len(expected_rules)} validation rules present (VAL-001 through VAL-006)")
          
          # Validate baseline producer locks (VAL-001)
          baseline_rules = activation.get('baseline_rules', {})
          if baseline_rules.get('FBL', {}).get('producer_lc') != 'LC02':
              print("❌ ERROR: VAL-001 violation - FBL producer must be LC02")
              exit(1)
          if baseline_rules.get('DBL', {}).get('producer_lc') != 'LC04':
              print("❌ ERROR: VAL-001 violation - DBL producer must be LC04")
              exit(1)
          if baseline_rules.get('PBL', {}).get('producer_lc') != 'LC10':
              print("❌ ERROR: VAL-001 violation - PBL producer must be LC10")
              exit(1)
          
          print("✅ VAL-001: Baseline producer locks enforced")
          
          # Check novel technology subdomains have full LC01-LC14 activation
          subdomains = activation.get('subdomains', {})
          novel_tech_subdomains = [
              name for name, config in subdomains.items()
              if config.get('novel_technology') == True
          ]
          
          print(f"\nNovel technology subdomains: {novel_tech_subdomains}")
          
          for subdomain_name in novel_tech_subdomains:
              subdomain = subdomains[subdomain_name]
              plm = subdomain.get('plm', {})
              ops = subdomain.get('ops', {})
              
              # Check LC03 is active (VAL-002)
              if not plm.get('LC03', {}).get('active'):
                  print(f"❌ ERROR: VAL-002 violation - {subdomain_name} must have LC03 active (Safety)")
                  exit(1)
              
              # Check LC06 is active (VAL-003)
              if not plm.get('LC06', {}).get('active'):
                  print(f"❌ ERROR: VAL-003 violation - {subdomain_name} must have LC06 active (Conformity)")
                  exit(1)
              
              print(f"✅ {subdomain_name}: LC03 and LC06 mandatory phases active")
          
          print("\n✅ T-Subdomain Activation validation PASSED")
          EOFPYTHON

  validate-gate-rulebook:
    name: Validate TLI Gate Rulebook
    runs-on: ubuntu-latest
    needs: yamllint
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml
      
      - name: Validate Gate Rulebook
        run: |
          python << 'EOFPYTHON'
          import yaml
          
          with open('lifecycle/TLI_GATE_RULEBOOK.yaml') as f:
              rulebook = yaml.safe_load(f)
          
          print("Validating TLI Gate Rulebook...")
          
          # Check gate groups exist
          gate_groups = ['gate_group_a_integrity', 'gate_group_b_baseline', 'gate_group_c_certification']
          
          for group in gate_groups:
              if group not in rulebook:
                  print(f"❌ ERROR: Missing gate group {group}")
                  exit(1)
          
          print("✅ All 3 gate groups present (A, B, C)")
          
          # Check GenLM run contract
          genlm_contract = rulebook.get('genlm_run_contract', {})
          if not genlm_contract:
              print("❌ ERROR: Missing GenLM run contract")
              exit(1)
          
          determinism = genlm_contract.get('determinism', {})
          required_determinism = ['model_pin', 'prompt_pin', 'policy_pin', 'temperature', 'top_p', 'seed']
          
          for req in required_determinism:
              if req not in determinism:
                  print(f"❌ ERROR: Missing determinism requirement: {req}")
                  exit(1)
          
          if determinism.get('temperature') != 0.0:
              print(f"❌ ERROR: Temperature must be 0.0 for determinism, got {determinism.get('temperature')}")
              exit(1)
          
          print("✅ GenLM deterministic run contract validated")
          print("   - Temperature: 0.0 ✓")
          print("   - All determinism parameters present ✓")
          
          print("\n✅ TLI Gate Rulebook validation PASSED")
          EOFPYTHON

  summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [yamllint, validate-lc-phase-registry, validate-t-subdomain-activation, validate-gate-rulebook]
    if: always()
    steps:
      - name: Check validation results
        run: |
          echo "## Lifecycle Registry Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All lifecycle registry validations completed." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ YAML Lint" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ LC Phase Registry Integrity" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ T-Subdomain Activation Rules" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ TLI Gate Rulebook" >> $GITHUB_STEP_SUMMARY
